version: v1.0
name: ccloud-auth-smoketests
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1

blocks:
  - name: "Linux x64: CCloud Auth Smoketest"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-amd64-1
      prologue:
        commands:
          - checkout
          - make ci-bin-sem-cache-restore
          - |
            if [[ "${SEMAPHORE_ORGANIZATION_URL}" == *".semaphoreci.com" ]]; then
              echo "Skipping Vault setup for Semaphore CI"
            else
              . vault-setup
            fi
      jobs:
        - name: "Mocha: CCloud Auth Smoketest (VS Code stable, ${{parameters.CCLOUD_BASE_PATH}})"
          commands:
            - make test-mocha TEST_SUITE="CCloud auth flow" IDE_SIDECAR_CONNECTIONS_CCLOUD_BASE_PATH=$CCLOUD_BASE_PATH
      epilogue:
        always:
          commands:
            - make remove-test-env
            - make ci-bin-sem-cache-store
            - make store-test-results-to-semaphore

after_pipeline:
  task:
    jobs:
      - name: Publish Test Results to Semaphore
        commands:
          - test-results gen-pipeline-report || echo "Could not publish pipeline test result report due to probably no test results to publish"
