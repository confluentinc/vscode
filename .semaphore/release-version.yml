version: v1.0
name: release-version
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1

auto_cancel:
  running:
    when: "branch != 'main'"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'main'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout
      - |
          if [ -n "$TARGET_BRANCH" ]; then
            git fetch origin "$TARGET_BRANCH:$TARGET_BRANCH"
            git checkout "$TARGET_BRANCH"
          else
            git fetch --all
          fi
          if [ -z "$COMMIT_SHA" ]; then
            COMMIT_SHA=$(git rev-parse HEAD)
          fi
          git checkout "$COMMIT_SHA"
      - . vault-setup
  env_vars:
    - name: NODE_ENV
      value: "production"

blocks:
  - name: "Parameter Verification"
    dependencies: []
    task:
      jobs:
        - name: "Parameter Verification"
          commands:
            # Fail early if the package.json version includes a micro-version when IS_PRERELEASE is false
            - |
              PKG_VERSION=$(jq -r '.version' package.json)
              echo "package.json version: $PKG_VERSION"
              if [ "$IS_PRERELEASE" != "true" ] && echo "$PKG_VERSION" | grep -q '-'; then
                echo "ERROR: package.json version contains a micro-version or prerelease segment ($PKG_VERSION) but IS_PRERELEASE is false. Aborting."
                exit 1
              fi
            # Ensure RELEASE_NAME is set and adjust for prereleases, if necessary
            - |
              if [ -n "$RELEASE_NAME" ] && [ "$RELEASE_NAME" != "RELEASE_NAME" ]; then
                echo "Using provided RELEASE_NAME: $RELEASE_NAME"
              else
                VERSION=$(cat .versions/next.txt)
                RELEASE_NAME="v$VERSION"
              fi
              if [ "$IS_PRERELEASE" = "true" ]; then
                if [[ "$RELEASE_NAME" != *"-pre"* ]]; then
                  RELEASE_NAME="${RELEASE_NAME}-pre"
                fi
              fi
            - echo "$RELEASE_NAME" > RELEASE_NAME.txt
            - artifact push workflow RELEASE_NAME.txt --force
  - name: "Delete GitHub Release and Tag"
    dependencies: ["Parameter Verification"]
    task:
      jobs:
        - name: "Delete GitHub Release and Tag"
          commands:
            - artifact pull workflow RELEASE_NAME.txt
            - RELEASE_NAME=$(cat RELEASE_NAME.txt)
            # Delete the existing GitHub Release and tag if they exist
            - gh release delete "$RELEASE_NAME" --yes || true
            - git tag -d "$RELEASE_NAME" || true
            - git push origin --delete "$RELEASE_NAME" || true
  - name: "Create GitHub Release and Tag"
    dependencies: ["Delete GitHub Release and Tag"]
    task:
      jobs:
        - name: "Create GitHub Release and Tag"
          commands:
            - artifact pull workflow RELEASE_NAME.txt
            - RELEASE_NAME=$(cat RELEASE_NAME.txt)
            # Try to determine previous release tag for generating release notes
            - |
              if [ -n "$PREVIOUS_RELEASE_TAG" ] && [ "$PREVIOUS_RELEASE_TAG" != "PREVIOUS_RELEASE_TAG" ]; then
                PREV_TAG="$PREVIOUS_RELEASE_TAG"
                echo "Using provided PREVIOUS_RELEASE_TAG: $PREV_TAG"
                NOTES_FLAGS="--generate-notes --notes-start-tag $PREV_TAG"
              else
                echo "Looking up the latest non-prerelease GitHub release tag..."
                RELEASES_URL="https://api.github.com/repos/confluentinc/vscode/releases"
                PREV_TAG=$(curl -s ${RELEASES_URL} | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
                if [ -z "$PREV_TAG" ]; then
                  echo "No previous non-prerelease tag found. Skipping automatic release notes generation."
                  NOTES_FLAGS=""
                else
                  echo "Found previous release tag: $PREV_TAG"
                  NOTES_FLAGS="--generate-notes --notes-start-tag $PREV_TAG"
                fi
              fi
            # Create the GitHub (pre)release, possibly with automatically-generated notes
            - |
              if [ "$IS_PRERELEASE" = "true" ]; then
                PRE_RELEASE_FLAG="--prerelease"
              else
                PRE_RELEASE_FLAG=""
              fi
            - |
              gh release create "$RELEASE_NAME" \
                $PRE_RELEASE_FLAG \
                --target "$COMMIT_SHA" \
                --title "$RELEASE_NAME" \
                $NOTES_FLAGS
  - name: "Package VSIX Files"
    dependencies: ["Create GitHub Release and Tag"]
    task:
      prologue:
        commands:
          - make install-dependencies
      jobs:
        - name: "Package VSIX Files"
          matrix:
            - env_var: TARGET
              values:
                - darwin-x64
                - darwin-arm64
                - linux-x64
                - linux-arm64
                - win32-x64
          commands:
            - |
              case "$TARGET" in
                darwin-x64)  export SIDECAR_OS_ARCH=macos-amd64 ;;
                darwin-arm64) export SIDECAR_OS_ARCH=macos-arm64 ;;
                linux-x64)   export SIDECAR_OS_ARCH=linux-amd64 ;;
                linux-arm64) export SIDECAR_OS_ARCH=linux-arm64 ;;
                win32-x64)   export SIDECAR_OS_ARCH=windows-x64 ;;
                *) echo "Unknown TARGET: $TARGET" && exit 1 ;;
              esac
            - make download-sidecar-executable
            - make download-third-party-notices-sidecar || true
            - npx gulp bundle
            - VSIX_FILE=$(find out/ -name "*.vsix")
            - artifact push workflow ${VSIX_FILE} --destination packaged-vsix-files/$(basename "${VSIX_FILE}") --force
  - name: "Upload VSIX Files to GitHub Release"
    dependencies: ["Package VSIX Files"]
    task:
      jobs:
        - name: "Upload VSIX Files to GitHub Release"
          commands:
            - artifact pull workflow RELEASE_NAME.txt
            - RELEASE_NAME=$(cat RELEASE_NAME.txt)
            - artifact pull workflow packaged-vsix-files/
            - |
              for vsix in packaged-vsix-files/*.vsix; do
                gh release upload "$RELEASE_NAME" "$vsix" --clobber
              done
